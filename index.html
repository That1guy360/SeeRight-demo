<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SeeRight</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; background:#0b0b0f; color:#fff; text-align:center; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 8px 0; font-size: 28px; }
    .sub { opacity: 0.88; margin: 0 0 18px 0; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin: 12px 0 12px 0; }
    input, select { padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1018; color:#fff; width:180px; }
    input[type="number"] { appearance: textfield; }
    button { padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.65); background:transparent; color:#fff; cursor:pointer; }
    button:hover { border-color:#fff; }
    button:active { transform: translateY(1px); }
    label { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0f1018; }
    canvas { background:#fff; border-radius:12px; box-shadow: 0 14px 40px rgba(0,0,0,.35); width: min(92vw, 640px); height: min(92vw, 640px); }
    .row { margin-top: 14px; }
    .card { margin:18px auto 0 auto; max-width:720px; text-align:left; border:1px solid rgba(255,255,255,.16); border-radius:14px; padding:14px; background: rgba(255,255,255,.03); }
    .card h3 { margin:0 0 6px 0; font-size: 16px; }
    .muted { opacity:.85; font-size: 14px; line-height: 1.35; }
    .pill { display:inline-block; margin-top:10px; padding:10px 14px; border:1px solid rgba(255,255,255,.65); border-radius:10px; text-decoration:none; color:#fff; }
    #msg { margin-top:12px; font-size:14px; opacity:.92; min-height:18px; }
    #err { text-align:left; white-space:pre-wrap; background:#2a0000; color:#fff; padding:10px; border-radius:10px; margin-top:14px; display:none; }
    iframe { width:100%; border:0; border-radius:12px; background:#fff; }
    .tiny { font-size: 12px; opacity: .75; margin-top: 6px; }
    .divider { height:1px; background:rgba(255,255,255,.12); margin:12px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SeeRight</h1>
    <p class="sub">Classic demo (no camera). Enter your prescription and toggle Before/After.</p>

    <div class="controls">
      <input type="number" id="sphere" placeholder="SPH (e.g., -2.00)" step="0.25" />
      <input type="number" id="cyl" placeholder="CYL (e.g., -1.00)" step="0.25" />
      <input type="number" id="axis" placeholder="AXIS (0–180)" step="1" min="0" max="180" />
      <input type="number" id="zoom" placeholder="Distance/Zoom (1.00)" step="0.05" value="1.00" min="0.50" max="2.00" />
    </div>

    <div class="controls">
      <button id="applyBtn">Apply (After)</button>
      <button id="toggleBtn">Before / After</button>
      <button id="copyBtn">Copy Presc</button>
      <button id="shareBtn">Share</button>
      <label title="For viewers without that prescription (optional)">
        <input type="checkbox" id="simulateChk" checked />
        Simulate blur (optional)
      </label>
    </div>

    <canvas id="glcanvas"></canvas>

    <!-- MUST be in SAME folder as this file -->
    <img id="chart" src="classic/SeeRight_Chart.png" alt="SeeRight Chart" crossorigin="anonymous" style="display:none;" />

    <div class="row">
      <div>Did this improve clarity?</div>
      <div class="controls" style="margin-top:8px;">
        <button id="fbYes">Yes</button>
        <button id="fbNo">No</button>
      </div>
      <div id="msg"></div>
    </div>

    <pre id="err"></pre>

    <div class="card">
      <h3>Join early access</h3>
      <div class="muted">Drop your email + prescription info. No spam. This helps tune the model.</div>

      <div class="divider"></div>

      <iframe
        src="https://docs.google.com/forms/d/e/1FAIpQLScIigh7GwKQuwz0049LPMuTFxMq7pyNpAKMTndySmCmEwDzQw/viewform?embedded=true"
        height="980"
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>

      <div class="tiny">
        If the embed doesn’t load on some devices, open it here:
        <a class="pill" href="https://docs.google.com/forms/d/e/1FAIpQLScIigh7GwKQuwz0049LPMuTFxMq7pyNpAKMTndySmCmEwDzQw/viewform"
           target="_blank" rel="noopener">Open Form</a>
      </div>
    </div>
  </div>

  <script>
    const errBox = document.getElementById("err");
    const msg = document.getElementById("msg");

    function showErr(text){
      errBox.style.display = "block";
      errBox.textContent = text;
    }
    window.onerror = (m, s, l, c) => showErr(`JS ERROR: ${m}\n${s}:${l}:${c}`);

    const canvas = document.getElementById("glcanvas");
    const gl = canvas.getContext("webgl", { preserveDrawingBuffer: true });

    if (!gl) {
      showErr("WebGL not available in this browser/device.");
      throw new Error("WebGL not available");
    }

    function resizeCanvas() {
      const cssSize = Math.min(window.innerWidth * 0.92, 640);
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.style.width = cssSize + "px";
      canvas.style.height = cssSize + "px";
      canvas.width = Math.floor(cssSize * dpr);
      canvas.height = Math.floor(cssSize * dpr);
    }
    resizeCanvas();

    const vertexShaderSource = `
      attribute vec2 a_position;
      varying vec2 v_uv;
      void main() {
        v_uv = (a_position * 0.5) + 0.5;
        gl_Position = vec4(a_position, 0.0, 1.0);
      }
    `;

    const fragmentShaderSource = `
      precision mediump float;

      uniform sampler2D u_tex;
      uniform float u_sphere;
      uniform float u_cyl;
      uniform float u_axis;   // radians
      uniform float u_zoom;   // 0.5..2.0
      uniform bool  u_apply;

      uniform bool u_sim;
      uniform vec2 u_px;

      varying vec2 v_uv;

      vec2 rotate2(vec2 p, float a) {
        float c = cos(a), s = sin(a);
        return vec2(c*p.x - s*p.y, s*p.x + c*p.y);
      }

      vec2 distort(vec2 uv, float sphere, float cyl, float axisRad) {
        vec2 c = uv - 0.5;

        vec2 r = rotate2(c, axisRad);
        float r2 = dot(c, c);

        float s = clamp(sphere, -12.0, 12.0);
        float k1 = s * 0.06;
        float k2 = s * 0.02;
        float sf = 1.0 + k1 * r2 + k2 * r2 * r2;
        r *= sf;

        float cy = clamp(cyl, -8.0, 8.0);
        float kc = cy * 0.04;
        float cf = 1.0 + kc * r2;
        r.x *= cf;

        vec2 outc = rotate2(r, -axisRad);
        return 0.5 + outc;
      }

      vec4 blur9(sampler2D t, vec2 uv, vec2 px, float amt) {
        vec2 r = px * amt;
        vec4 c = vec4(0.0);
        c += texture2D(t, uv + r*vec2(-1.0,-1.0)) * 0.0625;
        c += texture2D(t, uv + r*vec2( 0.0,-1.0)) * 0.1250;
        c += texture2D(t, uv + r*vec2( 1.0,-1.0)) * 0.0625;

        c += texture2D(t, uv + r*vec2(-1.0, 0.0)) * 0.1250;
        c += texture2D(t, uv + r*vec2( 0.0, 0.0)) * 0.2500;
        c += texture2D(t, uv + r*vec2( 1.0, 0.0)) * 0.1250;

        c += texture2D(t, uv + r*vec2(-1.0, 1.0)) * 0.0625;
        c += texture2D(t, uv + r*vec2( 0.0, 1.0)) * 0.1250;
        c += texture2D(t, uv + r*vec2( 1.0, 1.0)) * 0.0625;
        return c;
      }

      void main() {
        vec2 uv = v_uv;

        // ZOOM around center
        uv = (uv - 0.5) / u_zoom + 0.5;

        // keep chart upright
        uv.y = 1.0 - uv.y;

        if (u_apply) {
          vec2 d = distort(uv, -u_sphere, -u_cyl, u_axis);
          d = clamp(d, 0.002, 0.998);
          gl_FragColor = texture2D(u_tex, d);
          return;
        }

        if (u_sim) {
          float strength = clamp(abs(u_sphere) + 0.6*abs(u_cyl), 0.0, 12.0);
          float amt = strength * 1.6;
          gl_FragColor = blur9(u_tex, uv, u_px, amt);
        } else {
          gl_FragColor = texture2D(u_tex, uv);
        }
      }
    `;

    function compileShader(type, source) {
      const sh = gl.createShader(type);
      gl.shaderSource(sh, source);
      gl.compileShader(sh);
      if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {
        const info = gl.getShaderInfoLog(sh) || "Unknown shader error";
        showErr("SHADER COMPILE FAIL:\n" + info);
        throw new Error(info);
      }
      return sh;
    }

    const vs = compileShader(gl.VERTEX_SHADER, vertexShaderSource);
    const fs = compileShader(gl.FRAGMENT_SHADER, fragmentShaderSource);

    const program = gl.createProgram();
    gl.attachShader(program, vs);
    gl.attachShader(program, fs);
    gl.linkProgram(program);

    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
      const info = gl.getProgramInfoLog(program) || "Unknown program link error";
      showErr("PROGRAM LINK FAIL:\n" + info);
      throw new Error(info);
    }

    gl.useProgram(program);

    const positionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
      -1, -1,  1, -1, -1,  1,
      -1,  1,  1, -1,  1,  1
    ]), gl.STATIC_DRAW);

    const posLoc = gl.getAttribLocation(program, "a_position");
    gl.enableVertexAttribArray(posLoc);
    gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

    const sphereLoc = gl.getUniformLocation(program, "u_sphere");
    const cylLoc    = gl.getUniformLocation(program, "u_cyl");
    const axisLoc   = gl.getUniformLocation(program, "u_axis");
    const zoomLoc   = gl.getUniformLocation(program, "u_zoom");
    const applyLoc  = gl.getUniformLocation(program, "u_apply");
    const simLoc    = gl.getUniformLocation(program, "u_sim");
    const pxLoc     = gl.getUniformLocation(program, "u_px");
    const texLoc    = gl.getUniformLocation(program, "u_tex");

    const texture = gl.createTexture();
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.uniform1i(texLoc, 0);

    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([255,255,255,255]));
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

    function setPxUniform() {
      gl.uniform2f(pxLoc, 1.0 / canvas.width, 1.0 / canvas.height);
    }

    function draw() {
      gl.viewport(0, 0, canvas.width, canvas.height);
      gl.clearColor(1, 1, 1, 1);
      gl.clear(gl.COLOR_BUFFER_BIT);
      gl.drawArrays(gl.TRIANGLES, 0, 6);
    }

    const chartImg = document.getElementById("chart");

    function uploadChartTextureAndDraw() {
      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, texture);
      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, chartImg);
      draw();
    }

    chartImg.onload = uploadChartTextureAndDraw;
    chartImg.onerror = () => showErr("Image failed to load: classic/SeeRight_Chart.png (must exist in repo).");

    if (chartImg.complete && chartImg.naturalWidth > 0) uploadChartTextureAndDraw();

    let applyEffect = false;

    function readInputs() {
      const sphere = parseFloat(document.getElementById("sphere").value) || 0.0;
      const cyl    = parseFloat(document.getElementById("cyl").value) || 0.0;

      let axisDeg  = parseFloat(document.getElementById("axis").value);
      if (isNaN(axisDeg)) axisDeg = 90;
      axisDeg = Math.max(0, Math.min(180, axisDeg));
      const axisRad = axisDeg * Math.PI / 180.0;

      let zoom = parseFloat(document.getElementById("zoom").value);
      if (isNaN(zoom)) zoom = 1.0;
      zoom = Math.max(0.5, Math.min(2.0, zoom));

      return { sphere, cyl, axisDeg, axisRad, zoom };
    }

    function applyUniforms() {
      const { sphere, cyl, axisRad, zoom } = readInputs();
      const simOn = document.getElementById("simulateChk").checked;

      gl.uniform1f(sphereLoc, sphere);
      gl.uniform1f(cylLoc, cyl);
      gl.uniform1f(axisLoc, axisRad);
      gl.uniform1f(zoomLoc, zoom);
      gl.uniform1i(simLoc, simOn ? 1 : 0);

      setPxUniform();
    }

    document.getElementById("applyBtn").onclick = () => {
      applyUniforms();
      applyEffect = true;
      gl.uniform1i(applyLoc, 1);
      draw();
      if (msg) msg.textContent = "Applied (After). Toggle to compare.";
    };

    document.getElementById("toggleBtn").onclick = () => {
      applyUniforms();
      applyEffect = !applyEffect;
      gl.uniform1i(applyLoc, applyEffect ? 1 : 0);
      draw();
      if (msg) msg.textContent = applyEffect ? "After" : "Before";
    };

    document.getElementById("simulateChk").onchange = () => {
      applyUniforms();
      draw();
    };

    document.getElementById("zoom").onchange = () => {
      applyUniforms();
      draw();
    };

    document.getElementById("copyBtn").onclick = async () => {
      const { sphere, cyl, axisDeg, zoom } = readInputs();
      const text = `SPH ${sphere.toFixed(2)}, CYL ${cyl.toFixed(2)}, AXIS ${Math.round(axisDeg)}, ZOOM ${zoom.toFixed(2)}`;

      try {
        await navigator.clipboard.writeText(text);
        if (msg) msg.textContent = "Prescription copied.";
      } catch {
        window.prompt("Copy this:", text);
        if (msg) msg.textContent = "Copy the text above.";
      }
    };

    document.getElementById("shareBtn").onclick = async () => {
      const url = window.location.href;
      const shareData = {
        title: "SeeRight",
        text: "Try SeeRight — no camera, runs in-browser.",
        url
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
          if (msg) msg.textContent = "Shared.";
        } else {
          try {
            await navigator.clipboard.writeText(url);
            if (msg) msg.textContent = "Link copied — paste it anywhere.";
          } catch {
            window.prompt("Copy this link:", url);
            if (msg) msg.textContent = "Copy the link above.";
          }
        }
      } catch {
        if (msg) msg.textContent = "Share canceled.";
      }
    };

    document.getElementById("fbYes").onclick = () => {
      if (msg) msg.textContent = "Thanks. Drop your prescription + device in the form below.";
    };
    document.getElementById("fbNo").onclick = () => {
      const { sphere, cyl, axisDeg } = readInputs();
      if (msg) msg.textContent = `Thanks. Please submit: SPH ${sphere.toFixed(2)}, CYL ${cyl.toFixed(2)}, AXIS ${Math.round(axisDeg)} + device model.`;
    };

    applyUniforms();
    gl.uniform1i(applyLoc, 0);
    draw();

    window.addEventListener("resize", () => {
      resizeCanvas();
      applyUniforms();
      draw();
    });
  </script>
</body>
</html>
